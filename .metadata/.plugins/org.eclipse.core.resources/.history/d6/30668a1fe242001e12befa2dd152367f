<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>공공데이터 포털 API Example</title>
</head>
<body>
    <h1>서울 대기오염 정보</h1>
    <%
        // 공공데이터 포털에서 발급받은 API 인증키
        String apiKey = "ne53vYZ%2FHctQxGJhVLlcKvtvzi%2FHNfY42exeWo4iiO%2FxrJTgFukzupa98bwUDM318BruDv8y8kWtQDh76hClvQ%3D%3D";

        // API 호출 및 데이터 가져오기
        String apiUrl = "http://openapi.airkorea.or.kr/openapi/services/rest/ArpltnInforInqireSvc/getMsrstnAcctoRltmMesureDnsty";
        String stationName = "종로구"; // 관측소 이름
        String dataTerm = "DAILY"; // 데이터 요청 기간
        String version = "1.3"; // API 버전
        
        // API 호출 URL 생성
        String requestUrl = apiUrl + "?stationName=" + stationName + "&dataTerm=" + dataTerm + "&version=" + version + "&ServiceKey=" + apiKey;

        // API 응답 데이터 읽기
        java.net.URL url = new java.net.URL(requestUrl);
        java.net.HttpURLConnection con = (java.net.HttpURLConnection)url.openConnection();
        con.setRequestMethod("GET");
        int responseCode = con.getResponseCode();

        // API 응답 데이터 읽기
        if (responseCode == 200) { // 성공
            java.io.BufferedReader in = new java.io.BufferedReader(new java.io.InputStreamReader(con.getInputStream(), "UTF-8"));
            String inputLine;
            StringBuffer response = new StringBuffer();
            
            while ((inputLine = in.readLine()) != null) {
                response.append(inputLine);
            }
            in.close();

            // XML 파싱 및 출력
            org.w3c.dom.DocumentBuilderFactory factory = org.w3c.dom.DocumentBuilderFactory.newInstance();
            org.w3c.dom.DocumentBuilder builder = factory.newDocumentBuilder();
            org.w3c.dom.Document document = builder.parse(new org.xml.sax.InputSource(new java.io.StringReader(response.toString())));

            // 원하는 데이터 추출 (예시로 pm10Value 출력)
            org.w3c.dom.NodeList itemList = document.getElementsByTagName("item");
            
            out.println("<ul>");
            for (int i = 0; i < itemList.getLength(); i++) {
                org.w3c.dom.Element item = (org.w3c.dom.Element)itemList.item(i);
                String pm10Value = item.getElementsByTagName("pm10Value").item(0).getTextContent();
                out.println("<li>미세먼지 농도: " + pm10Value + "</li>");
            }
            out.println("</ul>");
        } else { // 실패
            out.println("API 호출에 실패하였습니다. 응답 코드: " + responseCode);
        }
    %>
</body>
</html>
